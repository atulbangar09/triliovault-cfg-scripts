---
- name: Remove old trilio repo
  file:
    path: /etc/apt/sources.list.d/trilio.list
    state: absent

- name: Stop tvault-objetc-store service if running
  service: name=tvault-object-store state=stopped
  ignore_errors: yes

- name: Stop tvault-contego service if running
  service: name=tvault-contego state=stopped
  ignore_errors: yes

- name: Reload Daemon
  shell: systemctl daemon-reload

- name: Triliovault - set nbd module options in modprobe conf
  become: true
  template:
    src: modprobe-nbd.conf.j2
    dest: "/etc/modprobe.d/nbd.conf"

- name: Triliovault - set module-load conf for nbd module
  become: true
  template:
    src: module-load-nbd.conf.j2
    dest: "/etc/modules-load.d/nbd.conf"

- name: Triliovault - load nbd module
  become: true
  modprobe:
    name: "nbd"
    params: "nbds_max=128"

- name: Triliovault - set module-load conf for rbd module
  become: true
  template:
    src: module-load-rbd.conf.j2
    dest: "/etc/modules-load.d/rbd.conf"

- name: Triliovault - load rbd module
  become: true
  modprobe:
    name: "rbd"
    state: "present"

- import_tasks: create_conf_dirs.yml

- name: Create datamover_logging.conf file
  template:
    src: datamover_logging.conf.j2
    dest: "{{ DATAMOVER_LOG_CONF }}"

- name: Copy repo file
  template:
    src: triliovault.list
    dest: "{{ trilio_apt_repo_file_path }}"

- name: update cache
  command: apt-get update

- name: Install python3-tvault-contego packages
  package:
    name: python3-tvault-contego
    state: latest

- name: Install python3-s3-fuse-plugin packages
  package:
    name: 
      - python3-s3-fuse-plugin
    state: latest
